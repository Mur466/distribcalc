Архитектура приложения
======================

Диагарамма архитектуры
----------------------
https://excalidraw.com/#json=o1fu4CmR545zTKTQlNv4q,wLnSy0wXCXjRgSLGZ7BcWw


Модули приложения
-----------------
1. Агент - выполняемый go-модуль. Выполняет вычисления простейших арифметических операций (из двух операндов). Получает задания от сервера и отдает результаты вычислений серверу через API (http/JSON). Может параллельно выполнять произвольное количество заданий в зависимости от настроек.

2. Сервер - выполняемый go-модуль. Получает задания от клиентов через API (http/JSON) и web-страницу. Разбивает сложные артифметические выражения на простейшие операции. По запросу агента выдает ему задание, готовое к вычислению. По запросу клиента получает результат вычислений и сохраняет. По мере готовности к вычислению следущих простейших операций, передает их агентам по их запросу. После выполнения всех входящих в выражение операций, сохраняет результат всего выражения. Отдает результат клиенту через  через API (http/JSON) и web-страницу. Может работать одновременно с произвольным количеством выражений и агентов, в том числе параллельно передавать разные операции одного выражения разным агентам. 


Архитектура агента
==================

Исходный код
------------
Весь агент находится в этом файле. Все остальные исходники относятся к серверу либо используются совместно сервером и агентом
\distribcalc\cmd\agent\main.go 

Конфигурация 
------------
Конфигурация выполняется через параметры командной строки
```
Usage of C:\Users\mvm65\AppData\Local\Temp\go-build1880269813\b001\exe\main.exe:
  -host string
        Host to get job from (default "127.0.0.1")
  -pollint int
        Poll interval (seconds) (default 15)
  -port string
        Port of the host (default "8080")
  -timeout int
        HTTP timeout (seconds) (default 10)
  -workers int
        Maximum number of workers (default 3)
```

Порядок работы
--------------

1. Агент стартует
2. Создает воркеров по числу указанных в параметрах (запускает горутины Worker)
3. Запускает TaskChecker(), который отвечает за получение заданий от сервера и передачу их воркерам, а также выполняет heartbeat (то есть пингует сервер в целях мониторинга)

Получение заданий / heartbeat
-----------------------------
TaskCheсker по таймеру вызывает GetOperation().

В условиях задачи перечислены endpoint'ы сервера,  среди них нет отдельного для выполнения heartbeat. Поэтому для выполнения heartbeat используется тот же endpoint /give-me-operation, что и для получения задания. Но при этом, если есть свободные воркеры, GetOperation() сообщает серверу свой статус "ready" и забирает задание. Если свободных воркеров нет, сообщает статус "busy" и задание не забирает.
После получения задания, оно попадает к воркеру через канал choper

Worker вычисляет результат и передает результат на сервер через endpoint /take-operation-result


Архитектура севера
==================

Основные структуры данных:
--------------------------
Модуль internal/task
- struct Task - представление задания на расчет сложного выражения
- Глобальная мапа Tasks - все задания. Ключ мапы совпадает с идентификатором заания в БД
  В стуктуре Task есть слайс TreeSlice, который содержит все узлы AST-дерева (Abstract Syntax Tree)
- struct Node содержит арифметическую операцию и древовидную связь между операциями в AST-дереве (ссылку на родительский узел и оба дочерних узла). Node_id совпадает с индексом узла в TreeSlice.
  Сквозная уникальность нод обеспечивается парой task_id/node_id

Модуль internal/agent
- struct Agent - информация о подкюченном агенте
- глобальная мапа Agents - полный список подключенных агентов

Состояния Task
--------------
- "parsing"  - еще не создан список нод (AST-дерево)
- "ready"    - AST дерево готово, ожидаем, когда первый агент придет за первой нодой (операцией)
- "in progress" - хотя бы одну операцию из дерева забрали на расчет
- "done"        - результаты вычисления всех операций получены. Результат всего выражения в поле Result
- "error"       - проблема при парсинге или вычислении. Описание проблемы в поле Message

Состояния Node
--------------
- "waiting"     - ожидаем вычисления подчиненных нод, передать на вычисление не можем
- "ready"       - нода готова к вычислению, ожидаем когда агент придет за нодой (операцией)
- "in progress" - операцию агент забрал на расчет
- "done"        - получен от агента результат операции. Результат всего выражения в поле Result
- "error"       - проблема при вычислении (деление на ноль или переполнение). Описание проблемы в поле Message

Web-server
----------
Используется библиотека gin-gonic, с ней чуть короче синтаксис

Для web-морды используется стандартный механизм шаблонов go

Список endpoint'ов описан в internal/router:
- /config - страница конфигурации (время выполнения арифметических операций)
- /set-config - сохранение конфигурации
- /tasks - отображение списка заданий и ввод нового выражения через веб-морду
- /calculate-expression - передача от клиента нового выражения на расчет (через веб-морду и через API)
- /agents - мониторинг агентов
- /give-me-operation API для агента, по которому агент забирает себе операцию для вычисления или просто сообщает о своем присутствии
- /take-operation-result API для агента, по которому агент возвращает серверу результат операции и статус

Сохранение состояния
--------------------
Состояние заданий и нод сохраняется в СУБД

Исходный код
------------
- distribcalc\cmd\mock_server
  - это тестовый сервер. Использовался на начальном этапе разработки для отладки агента. 
- distribcalc\cmd\server
  - main.go - основной файл
- distribcalc\cmd\server\templates
  - *.html - шаблоны web-морды
- distribcalc\database 
  - скрипты для создания БД. См. readme.md
- distribcalc\docs 
  - документация
- distribcalc\internal 
  - пакеты *.go из которых состоит сервер и структуры данных общие для сервера и агента

Описание работы
===============
Конфигурация
------------
Конфигурация выполняется через параметры командной строки
```
  -dbhost string
        Postgress host (default "localhost")
  -dbname string
        Postgress database name (default "distribcalc")
  -dbpassword string
        Postgress password (default "postgres")
  -dbport int
        Posgress port (default 5432)
  -dbuser string
        Postgress user (default "postgres")
  -httppport int
        HTTP port to listen to (default 8080)
```
Получение задания и парсинг
---------------------------
- Сервер через /calculate-expression получает выражение.
- Проверяет на повторный ext_id. Если такой уже вычисляли, просто возвращает его резузультат
- если выражение новое, выполняет построение AST-дерева встроенной функцией GO parser.ParseExpr().
- далее в task.buildtree() делается построение слайса нод в порядке дерева и контроль, что узлы дерева содержать только арифметические операции и целые числа
- После завершения этого процесса task переходит в "ready", а все его ноды либо "ready" либо "waiting"

Вычисление
----------
- Сервер через /give-me-operation передает первое попавшуюся ноду в статусе "ready" агенту (Если агент пришел со статусом "ready"). 
  - Переводит ноду в "in progress", если задание еще в "ready", то его тоже в "in_porgress"
  - Если агент пришел со статусом "busy", то ноду ему не дают. 
  - Фиксируется LastSeenDate агента (и для "busy", и для "ready").
- Сервер через /take-operation-result получает результат ноды. 
  - Если результат "error", то задание переводится в "error", все ноды в "ready" и "waiting" переводятся в "error".
  - Если результат ноды "done", то фиксируется ее результат. 
  - Далее смотрим выше по дереву, если мы на верхнем уровне, то переводим task в "done" и фиксируем результат. 
  - Если есть родительский узел, сохраняем наш результат в один из его операндов.
  - Проверяем готов ли второй его операнд. Если да, то переводим его в "ready", чтобы его забрал агент при следующем обращении

Мониторинг
----------
Функции мониторинга заданий на странице /tasks:
- Статус задания
- Время получения
- Время получения результата
- В процессе вычисления виден прогресс, сколько всего нод и сколько из них уже вычислено

Функции мониторинга агентов на странице /agents
- список агентов
- время первого подключения агента
- время последнего heartbeat агента
- общее количество воркеров
- количество свободных воркеров

Параллельность
--------------
Выражения со скобками типа (1+1)*(2+2) вычисляются параллельно разными агентами/воркерами (если есть свободные). В данном случае операции (1+1) и (2+2) будут вычислены параллельно, далее будет вычислено произведение скобок.

Отказоустойчивость
------------------
- Если агент не делал heartbeat в течение таймаута (берется максимальное время операции X 2), то он считается нерабочим. Вычеркивается из списка агентов. Если за ним числились ноды в статусе "in progress" они переводятся  "ready" и будут обработаны другими агентами. Для этих целей служит горутина CleanLostAgents()
- При старте сервера он читает Tasks из БД. Ноды в состоянии "in progress" переводятся в "ready".Если за время downtime сервера по ним агенты пытались прислать результат, который сервер не получил, ноды будут поданы в расчет повторно.
- Если по каким-то причинам результат ноды пришлет не тот агент, который забирал ее, сервер результат не принимает. Переводит ноду обратно в "ready" для повторного расчета.
- Перезапуск компонентов
- - Агент при выключении теряет вычисляемые выражения, но они будут переданы сервером другому агенту после таймаута
- - Сервер, пока выключен, не сможет получать новые задания и результаты от агентов. Но после старта повторно подаст на вычисление агентам операции, по которым он пропустил результат
- - База данных, пока выключена, скорее всего система будет не функциональна. После включения, функциональность должна восстановиться.






